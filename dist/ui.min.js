const t=(t,e)=>new Promise((s=>setTimeout((()=>s(e)),t)));function e(t,e){t&&null!=e&&("string"==typeof e||"number"==typeof e?t.innerHTML=e:Array.isArray(e)?(e=e.filter((t=>null!=t)),t.append(...e)):t.appendChild(e))}window.sleep=t;const s=new Set;function i(){let t=null;do{t="ui-"+Math.random().toString(16).slice(2)}while(s.has(t)||document.querySelector("#"+t));return s.add(t),t}function n(t,e="div"){let s=document.createElement(e);return s.innerHTML=t,s.firstElementChild}var a=Object.freeze({__proto__:null,sleep:t,append:e,uuid:i,htmlToElement:n,castHtmlElements:function(...t){return[...t]},shuffle:function(t){for(var e,s,i=t.length;0!==i;)s=Math.floor(Math.random()*i),e=t[i-=1],t[i]=t[s],t[s]=e;return t},downloadJson:function(t,e){const s=document.createElement("a");s.href=URL.createObjectURL(new Blob([JSON.stringify(e,null,"\t")],{type:"text/json"})),s.download=t,s.click()},dynamicallyLoadScript:async function(t){return new Promise((e=>{var s=document.createElement("script");s.src=t,s.onreadystatechange=e,s.onload=e,document.head.appendChild(s)}))}});class r extends HTMLElement{constructor(t,{clazz:s=""}={}){super(),this.self=this,t&&(Array.isArray(t)?e(this,t):"string"==typeof t?this.innerHTML=t:this.append(t)),s&&this.classList.add(...s.split(" ")),this.remove=this.remove.bind(this),this.intervals=[]}setInterval(t,e){let s=setInterval((()=>{document.body.contains(this)?t():this.intervals.forEach((t=>clearInterval(t)))}),e);return this.intervals.push(s),s}css(t){let e=getComputedStyle(this).getPropertyValue(t);return e||(e=this.style.getPropertyValue(t)),e}cssNumber(t){let e=this.css(t),s=parseFloat(e);return e.endsWith("ms")?s:e.endsWith("s")?1e3*s:s}setCss(t,e){this.style.setProperty(t,e)}getCss(t){this.style.getPropertyValue(t)}get visible(){return 0==this.self.hidden}set visible(t){t?this.self.removeAttribute("hidden"):this.self.setAttribute("hidden","")}show(t=null){return this.self.attach(t),this.self.visible=!0,this}hide(){return this.self.visible=!1,this}remove(){return this.self.parentElement?.removeChild(this.self),this}close(){let t=this.parentElement;for(;null==t.close;)if(t=t.parentElement,null==t)return this;return t.close(),this}attach(t=null){return this.self.parentElement||(null==t&&(t=document.body),t.appendChild(this.self)),this}querySelector(t){return super.querySelector(t)}querySelectorAll(t){return super.querySelectorAll(t)}static castHtmlElements(...t){return[...t]}#dropTypeSet=new Set;droppable=!1;makeDraggable(t="element",e=null){this.draggable=!0,this.addEventListener("dragstart",(s=>{if(null==e){if(null==this.dataset.drag){let t="D_"+Math.floor(1e6*Math.random()).toString(16);this.dataset.drag=t}let e=`[data-drag="${this.dataset.drag}"]`;s.dataTransfer.setData(t,e)}else s.dataTransfer.setData(t,e)}))}makeDroppable(){this.droppable=!0;let t=t=>{let e=t.dataTransfer.types;for(let s of this.#dropTypeSet)if(e.includes(s))return void t.preventDefault()};this.addEventListener("dragenter",t),this.addEventListener("dragover",t)}onDragOver(t,e){t=t.toLowerCase(),this.droppable||this.makeDroppable(),this.#dropTypeSet.add(t),this.addEventListener("dragover",(s=>{let i=s.dataTransfer.getData(t);""!=i&&(i.startsWith("[data-drag")&&(i=document.querySelector(i)),e(i,s))}))}onDrop(t,e){t=t.toLowerCase(),this.droppable||this.makeDroppable(),this.#dropTypeSet.add(t),this.addEventListener("drop",(s=>{let i=s.dataTransfer.getData(t);""!=i&&(i.startsWith("[data-drag")&&(i=document.querySelector(i)),e(i,s))}))}}customElements.define("ui-basic",r);class l extends r{constructor(t,e,{icon:s="",style:i="button",color:n=!1}={}){if(super(t),"string"==typeof e?(this.addEventListener("click",(t=>{t.ctrlKey?window.open(e):location.href=e})),this.addEventListener("auxclick",(t=>{1==t.button&&window.open(e)})),this.addEventListener("mousedown",(t=>{1==t.button&&t.preventDefault()}))):this.addEventListener("click",e),this.classList.add(i),n&&this.classList.add(n),s=s||this.attributes.getNamedItem("icon")?.value){let e=document.createElement("i"),i=s.trim().split(" ");i.includes("fa")||i.includes("fab")||i.includes("fas")||e.classList.add("fa"),e.classList.add(...i),this.prepend(e),""==t&&e.classList.add("icon-only")}}}customElements.define("ui-button",l);class o extends r{constructor(t,e){super('<input type="checkbox"/><div><span></span></div>'),this.value=t??"true"==this.attributes.getNamedItem("value")?.value,e&&this.querySelector("input").addEventListener("change",(()=>{e(this.value)}))}get value(){return this.querySelector("input").checked}set value(t){this.querySelector("input").checked=t}}customElements.define("ui-toggle",o);class h extends r{static STYLE={ROW:{parent:"table",wrap:"tr",label:"th",value:"td"},INLINE:{parent:null,wrap:"span",label:"label",value:"span"}};static TRUE_STRINGS=new Set("true","1","yes","t","y");constructor(t){super(),this.template=t,this.changeListeners=[],this.onChange=this.onChange.bind(this),this.formStyle=h.STYLE.ROW,this.configuration={formatting:{strings:{trim:!0}}},this.value={}}async build(t){this.value=t,this.changeListeners=[];let e=await this.jsonToHtml(this.template,t);return this.innerHTML="",this.append(...e),this.onChange(),this}async onChange(){let t=this.json();this.value=t;for(let e of this.changeListeners)await e(t);this.dispatchEvent(new Event("change"))}json(t=!1){return this._readValue(this,t)}_readValue(t,e=!1){let s={},i=t.querySelectorAll("[data-key]");for(let t of i){if(!e&&t.closest("[hidden]"))continue;let i=s,n=t.dataset.key.split("."),a=n.pop();for(let t of n){if(Array.isArray(i)){let t={};i.push(t),i=t}t.includes("[]")?(t=t.replace("[]",""),i[t]=i[t]??[]):i[t]=i[t]??{},i=i[t]}let r=t["checkbox"==t.type?"checked":"value"];"text"!=t.type&&"string"!=t.dataset.format||this.configuration.formatting.strings.trim&&(r=r.trim()),"number"!=t.type&&"number"!=t.dataset.format||(r=parseFloat(r)),"boolean"==t.dataset.format&&(r=TRUE_STRINGS.has(r?.toLowercase())),a.includes("[]")&&(a=a.replace("[]",""),i[a]=i[a]??[],i=i[a],a=null),Array.isArray(i)&&(null===a?a=i.length:(0!=i.length&&null==i[i.length-1][a]||i.push({}),i=i[i.length-1])),i[a]=r}return s}async jsonToHtml(t,e,s="",i={style:this.formStyle}){let n=[];Array.isArray(t)||(t=[t]);for(let a of t){"string"==typeof a&&(-1==a.indexOf(":")?a={key:null,type:a}:(a={key:a.split(":")[0],type:a.split(":")[1]},null==e&&(e={})));let t=(a.key?e[a.key]:e)??a.default;n.push(await this.oneItem(a,t,a.key?(s?s+".":"")+a.key:s,i))}if(i.style?.parent){let t=document.createElement(i.style?.parent);return t.append(...n),[t]}return n}_readJsonWithKey(t,e){try{let s=e.split(".");for(let e of s){if(null==t)return null;e.endsWith("[]")?(e=e.substring(0,e.length-2),t=(t=t[e])?.length>0?t[0]:null):t=t[e]}return t}catch(t){return null}}async oneItem(t,e,s,{style:a=h.STYLE.ROW}={}){let r=document.createElement(a.wrap);r.dataset.element=s;let o=async e=>{let o;if(t.key){if(o=document.createElement(a.label),o.innerHTML=t.name??t.key,t.hint){let e=document.createElement("div");e.innerHTML=t.hint,o.append(e)}r.append(o)}let u=document.createElement(a.value);if(u.classList.add("value"),r.append(u),"string"!=typeof t.type&&t.type){if("function"==typeof t.type){let i=t.type;if(i.prototype&&i.prototype.constructor.name){let i=new t.type(e,s,r);i.dataset.key=s,u.append(i)}else{let i=t.type(e,s,r);i.dataset.key=s,u.append(i)}}}else{let a="";switch(t.type){case"header":o.setAttribute("colspan","2"),o.classList.add("header"),u.remove();break;case"description":u.setAttribute("colspan","2"),u.classList.add("description"),u.innerHTML=t.key,o.remove();break;case"hr":u.setAttribute("colspan","2"),u.innerHTML="<hr/>";break;case"checkbox":a+=`<input data-key="${s}" type="checkbox" ${e?"checked":""}/>`,u.innerHTML=a;break;case"boolean":case"toggle":a+=`<ui-toggle data-key="${s}" value="${e??!1}"></ui-toggle>`,u.innerHTML=a;break;case"dropdown":case"select":case"list":a+=`<select data-key="${s}" data-format="${t.format}">`;let r=t.options;Array.isArray(r)||(r=await r(this.value)),a+=r.map((t=>`<option \n\t\t\t\t\t\t\t\t${e==(t.value?t.value:t)?"selected":""}\n\t\t\t\t\t\t\t\tvalue="${t.value?t.value:t}">${t.name?t.name:t}</option>`)).join(""),a+="</select>",u.innerHTML=a;break;case"text":a+=`<textarea data-key="${s}">${e??""}</textarea>`,u.innerHTML=a;break;case"number":a+=`<input data-key="${s}" type="number" value="${e??""}"/>`,u.innerHTML=a;break;case"object":case"compound":u.append(...await this.jsonToHtml(t.children,e??{},s));break;case"array":s+="[]";let d=t.style??"INLINE",c=h.STYLE[d],p=document.createElement("div");p.classList.add("array"),p.classList.add(d);let m=new l("Add",null,{icon:"fa-plus"}),f=async e=>{let i=document.createElement("span");i.classList.add("item"),i.append(...await this.jsonToHtml(t.children,e,s,{style:c})),i.append(new l("",(()=>{i.remove(),this.onChange()}),{icon:"fa-trash",style:"text",color:"error-color"}));let n=i.querySelectorAll("[data-key]");for(let t of n)t.addEventListener("change",this.onChange);p.append(i)};if(m.addEventListener("click",(async()=>{let e=await f(Array.isArray(t.children)?{}:null);return this.onChange(),e})),Array.isArray(e))for(let t of e)await f(t);u.append(p),u.append(m);break;case"string":default:let y=n(`<input data-key="${s}" type="text" placeholder="${t.placeholder??""}"/>`);if(y.value=e??null,t.disabled&&y.setAttribute("disabled",""),t.options){let s=t.options;Array.isArray(s)||(s=await s(this.value));let n=i(),a=K.html(`<datalist id="${n}">`+s.map((t=>`<option \n\t\t\t\t\t\t\t\t\t\t${e==(t.value?t.value:t)?"selected":""}\n\t\t\t\t\t\t\t\t\t\tvalue="${t.value?t.value:t}">${t.name?t.name:t}</option>`)).join("")+"</datalist>");u.append(a),y.addEventListener("focus",(()=>y.value="")),y.setAttribute("list",n)}u.append(y)}}let d=r.querySelectorAll("[data-key]");for(let t of d)t.addEventListener("change",(t=>{t.stopPropagation(),this.onChange()}))};if(await o(e),t.hidden&&this.changeListeners.push((e=>{r.hidden=t.hidden(e,r)})),t.redraw){let e=Array.isArray(t.redraw)?t.redraw:[t.redraw];for(let t of e){let e={},i=async i=>{let n=this._readJsonWithKey(i,t),a=JSON.stringify(n);if(e!==a){let t=this._readValue(r),i=this._readJsonWithKey(t,s);r.innerHTML="",await o(i),e=a}};this.changeListeners.push(i)}}return r}}customElements.define("ui-form",h);class u extends r{constructor(t="",{title:s="",clazz:i="",buttons:n="",header:a=!1,footer:r=!1}={}){super(),this.setAttribute("ui-panel",""),this.innerHTML.trim()||(this.innerHTML=`\n\t\t\t\t${a||s?`<header>${s}</header>`:""}\n\t\t\t\t<content></content>\n\t\t\t\t${r||n?`<footer>${n}</footer>`:""}\n\t\t\t`,e(this.content,t)),i&&this.classList.add(i)}get content(){return this.querySelector("content")}append(...t){e(this.content,t)}header(...t){e(this.querySelector("header"),t)}footer(...t){e(this.querySelector("footer"),t)}}customElements.define("ui-panel",u);class d extends r{constructor(t,{dismissable:e=!1}={}){super(t),e&&this.addEventListener("mousedown",this.remove)}}customElements.define("ui-splash",d);class c extends d{constructor(t,{title:e="",clazz:s="",buttons:i="",dismissable:n=!0,header:a=!1,footer:r=!1}={}){super("",{dismissable:n}),this.setAttribute("ui-modal","");let l=new u(t,{title:e,clazz:s,buttons:i,header:a,footer:r});l.addEventListener("mousedown",(()=>event.stopPropagation())),l.self=this,this.appendChild(l)}get panel(){return this.querySelector("ui-panel")}close(){return this.self.remove(),this}}customElements.define("ui-modal",c);class p extends r{constructor(){super(),this.attach()}}function m(t,e=!1){return Array.isArray(t)&&!0===e?t.map(m).join(" "):"object"==typeof t?JSON.stringify(t,null,"\t"):""+t}customElements.define("ui-toaster",p);class f extends r{constructor(t,{level:e="info"}={}){super(m(t,!0));let s=document.createElement("i"),i={debug:"fa-bug",info:"fa-info-circle",warn:"fa-exclamation-circle",error:"fa-exclamation-triangle",success:"fa-check-circle"}[e];s.classList.add("fa",i),this.prepend(s),document.querySelector("ui-toaster")||new p;let n=document.querySelector("ui-toaster");this.classList.add(e),n.prepend(this);document.querySelectorAll("ui-toast").length;setTimeout((()=>this.style.marginTop="10px"),10),setTimeout((()=>{this.style.marginTop="-50px",this.style.opacity="0"}),4800),setTimeout((()=>this.remove()),5e3)}}function y(...t){new f(t,{level:"info"})}function g(...t){new f(t,{level:"warn"})}function v(...t){new f(t,{level:"error"})}customElements.define("ui-toast",f);var b=Object.freeze({__proto__:null,popupForm:async function(t,{value:e={},title:s=null,submitText:i="Submit",wrapper:n=null,dismissable:a=!0}={}){return new Promise((r=>{let o=new h(t);o.build(e).then((()=>{let t=o;n&&(t=n(t));let e=new c(t,{title:s,buttons:"<ui-cancel></ui-cancel><ui-spacer></ui-spacer>",dismissable:a});e.close=()=>{e.self.remove(),r(null)},e.panel.footer(new l(i,(()=>{e.self.remove(),r(o.json())}))),e.show()}))}))},info:y,warn:g,error:v});class w extends r{constructor(t,{icon:e="",clazz:s=""}={}){if(super(t,{clazz:s}),e=e||this.attributes.getNamedItem("icon")?.value){let t=document.createElement("i"),s=e.trim().split(" ");s.includes("fa")||s.includes("fab")||s.includes("fas")||t.classList.add("fa"),t.classList.add(...s),this.prepend(t)}}}customElements.define("ui-badge",w);class E extends r{constructor(){super(),this.innerHTML=this.innerHTML||"Cancel",this.addEventListener("click",this.close.bind(this))}}customElements.define("ui-cancel",E);class L extends r{constructor(t){super(),this.setAttribute("ui-card","");let e=t||this.innerHTML;this.innerHTML='<div class="card"></div>',this.setContent(e)}setContent(t){"string"==typeof t?this.querySelector(".card").innerHTML=t??"":this.querySelector(".card").append(t)}async flip(){this.flipped=!this.flipped;let t=this.cssNumber("--duration");return new Promise((e=>setTimeout(e,t)))}get flipped(){return null==this.getAttribute("flipped")}set flipped(t){t?this.removeAttribute("flipped"):this.setAttribute("flipped","")}}customElements.define("ui-card",L);var T,x=(T="CodeWorker.js",function(t){return new Worker(T,t)});class S extends r{constructor(t){super(t),this.setContent(t||this.innerHTML)}preprocess(t){return t}setContent(t){t=this.preprocess(t);let e=new x;e.onmessage=t=>{this.classList.add("hljs"),this.innerHTML=t.data},e.postMessage(t)}}customElements.define("ui-code",S);class k extends r{target;items=[];#attachments=new WeakMap;constructor(t=null){super("<section></section>"),this.hide=this.hide.bind(this),this.hide();for(let t of["click","contextmenu"])this.addEventListener(t,this.hide),this.firstElementChild.addEventListener(t,(t=>{t.stopPropagation()}));t&&this.for(t)}for(t){let e=e=>{e.preventDefault(),this.renderMenu(t,e.pageX,e.pageY)};return t.addEventListener("contextmenu",e),t.setAttribute("context-menu",""),this.#attachments.set(t,e),this}renderMenu(t,e,s){this.target=t;let i=window.innerWidth,n=window.innerHeight,a=e<.75*i,r=s<.5*n;this.style.left=a?e+"px":null,this.style.right=a?null:i-e+"px",this.style.top=r?s+"px":null,this.style.bottom=r?null:n-s+"px";let l=!1;for(let e of this.items)e.element.hidden=e.hide&&e.hide(t),l=l||!e.element.hidden;l&&this.show()}detach(t){let e=this.#attachments.get(t);e&&(t.removeAttribute("context-menu",""),t.removeEventListener("contextmenu",e))}addItem(t,e,s=!1){let i=n(`<div>${t}</div>`);return this.items.push({element:i,hide:s}),i.addEventListener("click",(()=>{e(this.target),this.hide()})),this.firstElementChild.appendChild(i),this}addBreak(){return this.firstElementChild.appendChild(n("<hr/>")),this}clearMenuItems(){this.items=[],this.firstElementChild.innerHTML=""}}customElements.define("ui-context",k);class C extends r{#columns=0;#rows=0;constructor({padding:t,columnGap:e,rowGap:s}={}){super(),this.setAttribute("ui-grid",""),void 0!==t&&this.setCss("--padding",t),void 0!==s&&this.setCss("row-gap",s),void 0!==e&&this.setCss("column-gap",e)}get columns(){return this.#columns}set columns(t){this.#columns=t,this.setCss("--columns",t)}get rows(){return this.#rows}set rows(t){this.#columns=t,this.setCss("--rows",t)}put(t,e,s,i=1,n=1){this.rows<e+n-1&&(this.rows=e+n-1),this.columns<s+i-1&&(this.columns=s+i-1),Array.isArray(t)&&((t=new K.BasicElement(t)).style.display="flex"),t.style.setProperty("grid-area",`${e} / ${s} / span ${n} / span ${i}`),this.append(t)}}customElements.define("ui-grid",C);class M extends r{constructor(t,e,s){super(),this.obj=t,this.key=e,this.setAttribute("ui-input","")}get value(){return Reflect.get(this.obj,this.key)}set value(t){Reflect.set(this.obj,this.key,t)}label(t){return new $(this,t,{wrapped:!0})}}class A extends HTMLInputElement{constructor(t,e,s){super(),this.setAttribute("ui-input","")}label(t){return new $(this,t,{wrapped:!0})}}class I extends A{constructor(t,e,{callback:s=null,size:i=null,color:n=null,placeholder:a=null}={}){super(),this.type="text",this.value=Reflect.get(t,e)??null,i&&(this.style.width=24*i+"px"),n&&this.style.setProperty("--color",n),a&&this.setAttribute("placeholder",a),this.addEventListener("change",(()=>{let i=this.value;Reflect.set(t,e,i),s&&s(i)}))}}customElements.define("ui-stringinput",I,{extends:"input"});class _ extends A{constructor(t,e,{callback:s=null,size:i=null,color:n=null,placeholder:a=null}={}){super(),this.type="number",this.value=Reflect.get(t,e),i&&(this.style.width=24*i+"px"),n&&this.style.setProperty("--color",n),a&&this.setAttribute("placeholder",a),this.addEventListener("change",(()=>{let i=parseFloat(this.value);Reflect.set(t,e,i),s&&s(i)}))}}customElements.define("ui-numberinput",_,{extends:"input"});class O extends HTMLSelectElement{_value=null;constructor(t,e,{options:s=[],callback:i=null,size:n=null,color:a=null,placeholder:r=null}={}){super(t,e),this.obj=t,this.key=e,this.setAttribute("ui-input",""),n&&(this.style.width=24*n+"px"),a&&this.style.setProperty("--color",a),r&&this.setAttribute("placeholder",r),this.addEventListener("change",(()=>{let t=this.value;this.setValue(t),i&&i(t)})),this.renderOptions(s)}getValue(){return Reflect.get(this.obj,this.key)??null}setValue(t){Reflect.set(this.obj,this.key,t)}async renderOptions(t){"function"==typeof t&&(t=await t());let e=this.getValue();for(let s of t){let t=document.createElement("option");s&&s.hasOwnProperty("value")?(s.value==e&&t.setAttribute("selected",""),t.innerText=s.display??s.value):(s==e&&t.setAttribute("selected",""),t.innerText=s),this.append(t)}}}customElements.define("ui-selectinput",O,{extends:"select"});class H extends M{constructor(t,e,{options:s}){super(t,e),Array.isArray(this.value)||(this.value=[]);let i=document.createElement("content");this.list=i,this.append(i);let n=document.createElement("select");n.innerHTML="<option selected disabled hidden>Add...</option>"+s.map((t=>`<option>${t}</option>`)).join(""),n.addEventListener("change",(()=>{this.value.push(n.value),n.value="Add...",this.renderList()})),this.append(n),this.renderList()}renderList(){this.list.innerHTML="",this.list.append(...this.value.map(((t,e)=>{let s=new K.Badge(t);return s.append(new K.Button("",(()=>{this.value.splice(e,1),this.renderList()}),{icon:"fa-times",style:"text",color:"error-color"})),s})))}}customElements.define("ui-multiselectinput",H);class N extends M{constructor(t,e){super(t,e);let s=document.createElement("textarea");s.onkeydown=function(t){if("Tab"==t.key){t.preventDefault();let e=this.selectionStart;this.value=this.value.substring(0,this.selectionStart)+"\t"+this.value.substring(this.selectionEnd),this.selectionEnd=e+1}};let i=()=>{s.style.height="1px",s.style.height=s.scrollHeight+"px"};s.onkeyup=i,s.addEventListener("change",(()=>{try{let t=JSON.parse(s.value);this.value=t,this.classList.toggle("error",!1)}catch(t){this.classList.toggle("error",!0)}})),s.value=JSON.stringify(this.value??"",null,"\t"),this.append(s),setTimeout(i,10)}}customElements.define("ui-json-input",N);class $ extends HTMLLabelElement{input;constructor(t,e,{wrapped:s=!1}={}){if(super(),s)this.innerHTML=`<span class="label">${e}</span>`,this.append(t);else{let s=t.id;null==s&&(s="ui-"+Math.random().toString(16).slice(2),t.id=s),this.setAttribute("for",s),this.innerText=e}}get value(){return this.input.value}set value(t){this.input.value=t}}customElements.define("ui-label",$,{extends:"label"});class R extends ${constructor(t,e,s,i={}){super(new s(t,e,i),i.name??e,{wrapped:!0})}}customElements.define("ui-labelledinput",R,{extends:"label"});class P extends C{json;constructor(t,e,s){super(),this.json=e,this.build(t,e)}build(t,e){console.log("build",t,e);for(let s of Object.keys(t)){let i=t[s];if("function"==typeof i)this.append(new R(e,s,i));else if(Array.isArray(i))this.append(new R(e,s,i[0],i[1]));else{let t=Reflect.get(e,s);null==t&&(t={},Reflect.set(e,s,t)),this.build(i,t)}}}get value(){return this.json}}customElements.define("ui-form2",P);class j{path;pathVariables=[];func;constructor(t,e){for(;t.includes("{");){let e=t.substring(t.indexOf("{"),t.indexOf("}")+1);t=t.replace(e,"([^/]*)"),this.pathVariables.push(j.v(e.substring(1,e.length-1)))}this.path=new RegExp(t),this.func=e}static v(t){let[e,s]=t.split(":");return{name:e,set:(t,i)=>{if(i){switch(s){case"number":i=parseFloat(i);break;case"boolean":i="true"==i.toLowerCase();break;case"json":i=JSON.parse(i)}t[e]=i}}}}async handle(t,e){let s=t.match(this.path);if(!s||s[0].length!=t.length)return!1;let i={};s.shift();for(let t of this.pathVariables)t.set(i,s.shift());return await this.func(i)}}class z extends r{key=null;hash=null;depth=0;eventlistener;handlers=[];position=[0,0];static DIRECTION={NONE:0,LEFT:1,RIGHT:2,BOTTOM:3,TOP:4,RANDOM:100};static Handler=j;constructor(t=null){super(),this.key=t,this.eventlistener=()=>this.hashChange(),window.addEventListener("hashchange",this.eventlistener)}static read(t){let[e,s]=t.split(":"),i=window.location.hash.substring(1).split("|").filter((t=>""!=t)).map((t=>t.includes("=")?t.split("=",2):[null,t])).find((t=>t[0]==e))?.[1];if(i)switch(s){case"number":i=parseFloat(i);break;case"boolean":i="true"==i.toLowerCase();break;case"json":i=JSON.parse(i)}return i}remove(){return super.remove(),window.removeEventListener("hashchange",this.eventlistener),this}get value(){return this.hash}handler(t,e){return this.handlers.push(new j(t,e)),this}addHandler(t){this.handlers.push(t)}set(t){let e=window.location.hash.substring(1).split("|").filter((t=>""!=t)).map((t=>t.includes("=")?t.split("=",2):[null,t])),s=e.find((t=>t[0]==this.key));null==s&&(s=[this.key,null],e.push(s)),s[1]=t,window.location.hash=e.map((t=>t[0]?t.join("="):t[1])).join("|")}async hashChange(){let t=window.location.hash.substring(1).split("|").map((t=>t.includes("=")?t.split("=",2):[null,t])).find((t=>t[0]==this.key));null==t&&(t=[this.key,""]);let e=t[1],s=this.hash;if(this.hash=e,this.hash!=s)for(let t of this.handlers){let i=await t.handle(e,s);if(i){Array.isArray(i)?await this.swapContent(i[0],i[1]):await this.swapContent(i,null);break}}}async swapContent(s,i=z.DIRECTION.RIGHT){let n,a,r=document.createElement("content");if(e(r,s),null==this.firstElementChild)return this.appendChild(r);if(null==i)return this.firstElementChild.remove(),void this.appendChild(r);if(i==z.DIRECTION.RANDOM){let t=[z.DIRECTION.RIGHT,z.DIRECTION.LEFT,z.DIRECTION.TOP,z.DIRECTION.BOTTOM];i=t[Math.floor(Math.random()*t.length)]}if(Array.isArray(i)){console.log(this.position,i);let t=i;i=this.position[0]!=i[0]?this.position[0]>i[0]?z.DIRECTION.LEFT:z.DIRECTION.RIGHT:this.position[1]!=i[1]?this.position[1]<i[1]?z.DIRECTION.BOTTOM:z.DIRECTION.TOP:z.DIRECTION.RIGHT,this.position=t}switch(i){case z.DIRECTION.RIGHT:[n,a]=["right","left"];break;case z.DIRECTION.LEFT:[n,a]=["left","right"];break;case z.DIRECTION.TOP:[n,a]=["top","bottom"];break;case z.DIRECTION.BOTTOM:[n,a]=["bottom","top"]}let l=this.cssNumber("--timing");r.classList.add(n),this.appendChild(r),t(50).then((()=>{r.classList.remove(n),this.firstElementChild.classList.add(a),setTimeout((()=>this.firstElementChild.remove()),l)}))}}customElements.define("ui-hash",z);class D extends S{constructor(t){super(t)}preprocess(t){return"object"==typeof t?JSON.stringify(t,null,"\t"):JSON.stringify(JSON.parse(t),null,"\t")}}customElements.define("ui-json",D);let q=0;class V extends r{elementMap=new WeakMap;static ASC=!0;static DESC=!1;dirty=!0;_sort=null;attrs={};static ITEMS_COLUMNS_KEY="--item-columns";static ITEMS_PER_PAGE_KEY="--items-per-page";constructor(t,e={}){super(),this.setAttribute("ui-list",""),this.innerHTML=this.listLayout,this.listBody=this.querySelector(".list"),this._sort=null,this._data=[],this.display=[],this.lookup={},this._filterFunc=null,this._itemDisplayFunc=t,this.pageNumber=0,e.itemColumns&&(this.itemColumns=e.itemColumns),e.itemsPerPage&&(this.itemsPerPage=e.itemsPerPage)}set itemColumns(t){this.setCss(V.ITEMS_COLUMNS_KEY,t)}get itemsPerPage(){return this.cssNumber(V.ITEMS_PER_PAGE_KEY)||24}set itemsPerPage(t){this.setCss(V.ITEMS_PER_PAGE_KEY,t)}get listLayout(){return'\n\t\x3c!-- pagination --\x3e\n\t<header>\n\t\t<span><span class="sort"></span></span>\n\t\t<ui-spacer></ui-spacer>\n\t\t<span class="paging top"></span>\n\t</header>\n\n\t<content class="list">\n\t</content>\n\n\t\x3c!-- pagination --\x3e\n\t<footer>\n\t\t<ui-spacer></ui-spacer>\n\t\t<div class="paging bottom"></div>\n\t</footer>'}set data(t){this._data=t;for(let t of this._data)null==t.__id&&(t.__id=t.id?t.id:""+q++);this.dirty=!0}get data(){return this._data}addAttribute(t,e=(e=>e[t]),s=e,i=null){return this.attrs[t]={id:q++,name:t,width:i,value:"string"==typeof e?t=>t[e]:e,displayFunc:"string"==typeof s?t=>t[s]:s},this.dirty=!0,this}_filtered(t){return null==this._filterFunc||this._filterFunc(t)}filter(t=this._filterFunc){this._filterFunc=t,this.dirty=!0,this.page(0)}sortDisplay(){let t=this.querySelector(".sort"),e=document.createElement("select");e.innerHTML=Object.values(this.attrs).map((t=>t.value?`<option value="${t.name}:asc" >▲ ${t.name}</option>\n\t\t\t<option value="${t.name}:desc">▼ ${t.name}</option>`:"")).join(""),e.value=this._sort?`${this._sort.attr.name}:${this._sort.asc?"asc":"desc"}`:null,e.onchange=()=>{let t=e.value.split(":");this.sort(t[0],"asc"==t[1])},t.innerHTML="",t.appendChild(e),0==Object.values(this.attrs).length&&(t.style.display="none")}async render(t=!1){t&&(this.dirty=!0),this.sortDisplay(),await this.page()}async getItemElement(t){if(!this.elementMap.has(t)){let e=await this.renderItem(t);if("string"==typeof t)return e;this.elementMap.set(t,e)}return this.elementMap.get(t)}async renderItem(t){return await this._itemDisplayFunc(t)}async sort(t=this._sort?.attr,e=!this._sort?.asc){this.dirty=!0;let s="string"==typeof t?this.attrs[t]:t;this._sort=null==t?null:{attr:s,asc:e},0!=this.data.length&&await this.render()}async page(t=this.pageNumber){this.dirty&&(this.display=[...this.data],this.display=this.display.filter((t=>this._filtered(t))),this._sort&&(this.display=this.display.sort(((t,e)=>{let s=t?this._sort.attr.value(t):null,i=e?this._sort.attr.value(e):null;if(s==i)return 0;let n=this._sort.asc?1:-1;return null==i?n:null==s?-n:n*(""+s).localeCompare(""+i,"en",{sensitivity:"base",ignorePunctuation:"true",numeric:!0})}))),this.dirty=!1,this.pageNumber=0);let e=this.display.length,s=Math.ceil(e/this.itemsPerPage),i=s>1;if(this.pageNumber=isNaN(t)?0:Math.max(Math.min(t,s-1),0),i){let t=this.pagingMarkup(this.pageNumber,s,e);this.querySelector(".paging.top").innerHTML=t,this.querySelector(".paging.bottom").innerHTML=t,r.castHtmlElements(...this.querySelectorAll("[data-page]")).forEach((t=>t.addEventListener("click",(()=>{this.page(parseInt(t.dataset.page))}))))}else this.querySelector(".paging.top").innerHTML="",this.querySelector(".paging.bottom").innerHTML="";this.listBody.innerHTML="";for(let t=this.pageNumber*this.itemsPerPage;t<(this.pageNumber+1)*this.itemsPerPage&&t<e;t++){let e=this.display[t],s=await this.getItemElement(e);s instanceof r?s.attach(this.listBody):this.listBody.appendChild(s)}}pagingMarkup(t,e,s){let i="";i+=`${s} items`,i+=`<ui-button data-page="0" class="near ${0==t?"active":""}">1</ui-button>`;let n=t-1,a=t+1+1;n<1&&(a+=1-n,n=1),a>e-1&&(n-=a-e+1,a=e-1,n=Math.max(1,n)),n>1&&(i+="<span>...</span>");for(let e=n;e<a;e++)i+=`<ui-button data-page="${e}" class="${e==t?"active":""}">${e+1}</ui-button>`;return a<e-1&&(i+="<span>...</span>"),i+=`<ui-button data-page="${e-1}" class="near ${t==e-1?"active":""}">${e}</ui-button>`,i}}customElements.define("ui-list",V);class F extends V{constructor(t={}){super((async t=>{let s=document.createElement("tr");s.dataset.tableId=t.__id;for(let i of Object.values(this.attrs)){let n=document.createElement("td");e(n,await i.displayFunc(t)),s.append(n)}return s}),t),this.setAttribute("ui-table","")}get listLayout(){return'<table>\n<thead>\n\t\x3c!-- pagination --\x3e\n\t<tr><td class="paging top" colspan="100"></td></tr>\n\n\t<tr class="headers"></tr>\n\t\x3c!-- filters --\x3e\n</thead>\n<tbody class="list">\n</tbody>\n<tfoot>\n\t\x3c!-- pagination --\x3e\n\t<tr><td class="paging bottom" colspan="100"></td></tr>\n</tfoot>\n</table>'}sortDisplay(){let t=this.querySelector("thead tr.headers"),e=Object.values(this.attrs),s="";for(let t of e)s+=`<th data-table-id="${t.id}" ${this.attrs[t.name].value?`data-sort="${t.name}"`:""} style="${t.width?`width:${t.width}`:""}">${t.name}</th>`;t.innerHTML=s,t.querySelectorAll("th").forEach((t=>{t.dataset.sort&&(t.onclick=e=>{this.sort(t.dataset.sort)})})),this._sort&&this.querySelector(`thead tr.headers th[data-table-id='${this._sort.attr.id}']`).classList.add(this._sort.asc?"asc":"desc")}}customElements.define("ui-table",F);class B extends r{constructor(){super()}}customElements.define("ui-spacer",B);class J extends r{constructor(){super();let t=this.attributes.getNamedItem("size")?.value||"1em";this.style.setProperty("--size",t)}}customElements.define("ui-spinner",J);class W extends r{#view={parent:null,x:0,y:0,zoom:1,get width(){return this.parent.element.width/this.zoom},get height(){return this.parent.element.height/this.zoom}};attachments=[];constructor({flipY:t=!1}={}){super(),this.#view.parent=this,this.canvas=document.createElement("canvas"),this.append(this.canvas)}addAttachment(t,e=!0){this.attachments.push(t),this.append(t),e&&this.updateAttachments()}removeAttachment(t,e=!0){this.attachments=this.attachments.filter((e=>e!=t)),this.removeChild(t),e&&this.updateAttachments()}center(t,e){this.setCenter(t,e)}setCenter(t,e){this.#view.x=t-this.#view.width/2,this.#view.y=e-this.#view.height/2}getCenter(){return this.toView(this.#view.width/2,this.#view.height/2)}zoom(t,e,s){this.setZoom(t,e,s)}setZoom(t,e=null,s=null){if(null==e){let t=this.getCenter();e=t.x,s=t.y}let i=this.toScreen(e,s);this.#view.zoom=t;let n=this.toScreen(e,s),a=n.x-i.x,r=n.y-i.y;this.panScreen(a,r)}pan(t,e){this.panScreen(t,e)}panScreen(t,e){this.#view.x+=t/this.#view.zoom,this.#view.y+=e/this.#view.zoom}toView(t,e){let s=this.#view,i=this.element,n={x:(t-i.x)/s.zoom+s.x,y:(e-i.y)/s.zoom+s.y};return n.out=n.x<s.x||n.x>s.x+s.width||n.y<s.y||n.y>s.y+s.height,n}toScreen(t,e){let s=this.#view;return{x:(t-s.x)*s.zoom,y:(e-s.y)*s.zoom}}get element(){return this.getBoundingClientRect()}#lastV;grid=[{step:1,offset:1,color:"#7772"},{step:6,offset:6,color:"#7772"},{step:12,offset:0,color:"#7774"},{step:1/0,offset:0,color:"#999"}];render(){let t=this.#view,e=JSON.stringify({x:t.x,y:t.y,w:t.width,h:t.height,z:t.zoom});if(null!=this.#lastV&&this.#lastV==e)return this.#lastV=e,void this.updateAttachments();this.#lastV=e;let s=this.element;this.canvas.width==s.width&&this.canvas.height==s.height||(this.canvas.width=s.width,this.canvas.height=s.height);let i=this.canvas.getContext("2d");i.resetTransform(),i.clearRect(0,0,this.canvas.width,this.canvas.height);let n=-t.x*t.zoom,a=-t.y*t.zoom,r=t.width*t.zoom,l=t.height*t.zoom;i.lineWidth=1;for(let e of this.grid)if(!(t.zoom*e.step<10)){i.beginPath(),i.strokeStyle=e.color;for(let s=e.offset??0;s<1e3*e.step;s+=e.step){let e=s*t.zoom;e+a>0&&e+a<l&&(i.moveTo(0,e+a),i.lineTo(r,e+a)),-e+a>0&&-e+a<l&&(i.moveTo(0,-e+a),i.lineTo(r,-e+a)),e+n>0&&e+n<r&&(i.moveTo(e+n,0),i.lineTo(e+n,l)),-e+n>0&&-e+n<r&&(i.moveTo(-e+n,0),i.lineTo(-e+n,l))}i.stroke()}this.updateAttachments()}updateAttachments(){let t=this.#view;for(let e of this.attachments)if(e.render)e.render(this);else{let s=e.scalar??1,i=(e.x??0)*s-t.x,n=(e.y??0)*s-t.y,a=`translate(${i*t.zoom}px, ${n*t.zoom}px) scale(${t.zoom*s})`;e.style.transform=a}}bindMouse(){let t=null;this.addEventListener("contextmenu",(t=>{t.preventDefault()})),this.addEventListener("wheel",(t=>{let e=this.toView(t.x,t.y),s=Math.exp((480*Math.log(this.#view.zoom)-t.deltaY)/480);this.setZoom(s,e.x,e.y),this.render()})),document.addEventListener("mousedown",(e=>{1==e.button&&(t=[e.x,e.y]),e.button,e.button})),document.addEventListener("mousemove",(e=>{if(t){let s=[e.x,e.y];this.panScreen(t[0]-s[0],t[1]-s[1]),t=s,this.render()}})),document.addEventListener("mouseup",(e=>{if(1==e.button){let s=[e.x,e.y];this.panScreen(t[0]-s[0],t[1]-s[1]),t=null,this.render()}e.button,e.button}))}}customElements.define("ui-viewport",W);let G=[import.meta.url+"/../ui.css","https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,wght@0,200;0,300;0,400;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,600;1,700;1,800;1,900&display=swap","https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"],Y=document.createElement("head");Y.innerHTML=G.map((t=>`<link href="${t}" rel="stylesheet">`)).join(""),document.head.prepend(...Y.childNodes);const K={BasicElement:r,Badge:w,Button:l,Cancel:E,Card:L,Code:S,ContextMenu:k,Form:h,Form2:P,Grid:C,HashManager:z,InputLabel:$,Json:D,JsonInput:N,LabelledInput:R,List:V,Modal:c,MultiSelectInput:H,NumberInput:_,Panel:u,SelectInput:O,Spacer:B,Spinner:J,Splash:d,StringInput:I,Table:F,Toast:f,Toggle:o,Viewport:W,info:y,warn:g,error:v,html:n,uuid:i,sleep:t,utils:a,factory:b};window.UI=K;let U=n;export default K;export{w as Badge,r as BasicElement,l as Button,E as Cancel,L as Card,S as Code,k as ContextMenu,h as Form,C as Grid,z as HashManager,$ as InputLabel,D as Json,R as LabelledInput,V as List,c as Modal,H as MultiSelectInput,_ as NumberInput,u as Panel,B as Spacer,J as Spinner,d as Splash,I as StringInput,F as Table,f as Toast,o as Toggle,W as Viewport,U as createElement,b as factory,a as utils};
